<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>API Automation Execution Dashboard - Enhanced</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  :root{
    --bg:#f3f8ff; --primary:#003366; --accent:#0d6efd; --ok:#28a745; --bad:#dc3545; --warn:#ffc107;
    --card:#ffffff; --muted:#6b7280;
  }
  *{box-sizing:border-box;font-family:Inter, Arial, Helvetica, sans-serif}
  body{margin:0;background:var(--bg);color:var(--primary);padding:18px}
  .container{max-width:1200px;margin:12px auto;padding:18px;position:relative}
  header{display:flex;align-items:center;gap:18px;margin-bottom:10px}
  .logo{width:120px;height:60px;overflow:hidden;border-radius:8px}
  .logo img{width:100%;height:100%;object-fit:cover}
  h1{margin:0;font-size:20px}
  .meta{color:var(--muted);font-size:13px;margin-top:4px}

  .controls{display:flex;gap:10px;align-items:center;margin:18px 0;flex-wrap:wrap}
  .controls > *{background:var(--card);padding:8px 10px;border-radius:8px;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
  select,input[type="search"]{border:1px solid #e6eefc;padding:6px 8px;border-radius:6px}
  button{border:0;background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
  button.ghost{background:transparent;color:var(--primary);border:1px solid #e6eefc}
  .small{padding:6px 8px;font-size:13px}

  .top-summary{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:10px}
  .card{flex:1;min-width:160px;background:var(--card);padding:12px;border-radius:12px;box-shadow:0 8px 24px rgba(12,30,60,0.06)}
  .card h3{margin:0;font-size:13px;color:var(--muted)}
  .card .big{font-size:20px;font-weight:700;margin-top:6px}

  .charts{display:flex;gap:16px;margin-top:12px;flex-wrap:wrap}
  .chart-box{background:var(--card);padding:14px;border-radius:12px;flex:1;min-width:280px;box-shadow:0 8px 24px rgba(12,30,60,0.06)}
  .legend-inline{display:flex;gap:10px;align-items:center;margin-top:8px;font-size:13px}
  .legend-inline span{display:inline-flex;align-items:center;gap:8px}
  .legend-swatch{width:12px;height:12px;border-radius:3px;display:inline-block}

  table{width:100%;border-collapse:collapse;margin-top:16px;background:var(--card);border-radius:8px;overflow:hidden;box-shadow:0 8px 24px rgba(12,30,60,0.06)}
  thead th{background:linear-gradient(90deg,#003366,#00509e);color:#fff;padding:10px 8px;text-align:left;font-size:13px}
  tbody td{padding:10px 8px;border-top:1px solid #eef4ff;font-size:13px;color:#111}
  tbody tr:hover{background:#f7fbff}
  .status-pill{padding:4px 8px;border-radius:999px;font-weight:600;font-size:12px;color:#fff;display:inline-block}
  .status-passed{background:var(--ok)}
  .status-failed{background:var(--bad)}
  .status-skipped{background:var(--warn);color:#333}

  .table-actions{display:flex;gap:8px;align-items:center}
  .json-modal{position:fixed;left:0;right:0;top:0;bottom:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:999}
  .json-content{width:90%;max-width:1000px;height:80%;background:#fff;border-radius:8px;padding:12px;overflow:auto;box-shadow:0 18px 48px rgba(2,6,23,0.5)}
  .close{float:right;background:#eee;border-radius:6px;padding:6px;cursor:pointer}
  .watermark{position:fixed;right:-40px;top:40%;opacity:0.07;transform:rotate(-12deg);font-size:60px;color:var(--primary);pointer-events:none;z-index:0}

  footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}
  @media(max-width:820px){
    .charts{flex-direction:column}
  }
</style>
</head>
<body>
  <div class="container">
    <div class="watermark">CHANGEPOND</div>

    <header>
      <div class="logo"><img src="logo/company_logo.jpg" alt="logo" onerror="this.style.display='none'"></div>
      <div>
        <h1>API Automation Execution Dashboard — Enhanced</h1>
        <div class="meta" id="metaInfo">Environment: DEV | Mode: Suite | Executed: Today | Duration: --</div>
      </div>
    </header>

    <div class="controls">
      <label>Run:
        <select id="runSelector" class="small"></select>
      </label>

      <label>Status:
        <select id="statusFilter" class="small">
          <option value="all">All</option>
          <option value="passed">Passed</option>
          <option value="failed">Failed</option>
          <option value="skipped">Skipped</option>
        </select>
      </label>

      <input type="search" id="searchBox" placeholder="Search Testcase / Action..." />

      <button id="downloadCsv" title="Download filtered rows as CSV">Download CSV</button>
      <button id="toggleWatermark" class="ghost small">Toggle Watermark</button>
      <button id="refresh" class="ghost small">Refresh Data</button>
    </div>

    <div class="top-summary">
      <div class="card">
        <h3>Total Tests</h3><div class="big" id="totalTests">--</div>
      </div>
      <div class="card">
        <h3>Passed</h3><div class="big" id="totalPassed">--</div>
      </div>
      <div class="card">
        <h3>Failed</h3><div class="big" id="totalFailed">--</div>
      </div>
      <div class="card">
        <h3>Skipped</h3><div class="big" id="totalSkipped">--</div>
      </div>
    </div>

    <div class="charts">
      <div class="chart-box">
        <canvas id="trendChart" height="220"></canvas>
        <div class="legend-inline">
          <span><i class="legend-swatch" style="background:var(--ok)"></i> Passed</span>
          <span><i class="legend-swatch" style="background:var(--bad)"></i> Failed</span>
          <span><i class="legend-swatch" style="background:var(--warn)"></i> Skipped</span>
        </div>
      </div>

      <div class="chart-box">
        <canvas id="doughnutChart" height="220"></canvas>
        <div style="margin-top:10px;display:flex;gap:12px;flex-wrap:wrap">
          <div class="card" style="min-width:140px;flex:0">
            <h3>Avg Response Time</h3><div class="big" id="avgTime">-- ms</div>
          </div>
          <div class="card" style="min-width:140px;flex:0">
            <h3>Fastest</h3><div class="big" id="fastTime">-- ms</div>
          </div>
          <div class="card" style="min-width:140px;flex:0">
            <h3>Slowest</h3><div class="big" id="slowTime">-- ms</div>
          </div>
        </div>
      </div>
    </div>

    <table id="resultTable" aria-live="polite">
      <thead>
        <tr>
          <th style="width:120px">Run</th>
          <th style="width:110px">Case ID</th>
          <th>Action</th>
          <th style="width:120px">Status</th>
          <th style="width:120px">Response Time (ms)</th>
          <th style="width:140px">Content-Type</th>
          <th style="width:160px">Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
      <div style="color:var(--muted)">Tip: Click "View JSON" to inspect response body. Use filters and then Download CSV for reports.</div>
    </div>

    <footer>Powered by Changepond Technologies • API QA Automation</footer>
  </div>

  <!-- JSON modal -->
  <div class="json-modal" id="jsonModal">
    <div class="json-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:700">Response Preview</div>
        <div><button class="close" id="closeModal">Close</button></div>
      </div>
      <pre id="jsonText" style="white-space:pre-wrap;font-size:13px;line-height:1.4"></pre>
    </div>
  </div>

<script>
/*
  Sample data for 7 runs. Replace these objects with your actual TestNG / Excel-derived data when wiring.
  Each row: { run: 'Run1', caseId:'TC001', action:'GET /api/x', status:'passed'|'failed'|'skipped', responseTime:123, contentType:'application/json', responseBody: {...} }
*/
const SAMPLE_DATA = [
  // Run1
  {run:'Run1', caseId:'TC001', action:'POST /api/authenticate', status:'passed', responseTime:2029, contentType:'application/json', responseBody:{user:'superadmin'}},
  {run:'Run1', caseId:'TC002', action:'GET /api/GraphApplicationRegister', status:'failed', responseTime:190, contentType:'application/json', responseBody:{error:'Unauthorized'}},
  // Run2
  {run:'Run2', caseId:'TC003', action:'GET /api/GraphUserdetails', status:'passed', responseTime:83, contentType:'application/json', responseBody:{items:3}},
  // Run3
  {run:'Run3', caseId:'TC004', action:'GET api/masters/GetMasters', status:'passed', responseTime:316, contentType:'application/json', responseBody:{mas:'data'}},
  // Run4
  {run:'Run4', caseId:'TC005', action:'POST /api/items', status:'skipped', responseTime:0, contentType:'', responseBody:{}},
  // Run5
  {run:'Run5', caseId:'TC006', action:'PUT /api/items/1', status:'passed', responseTime:120, contentType:'application/json', responseBody:{ok:true}},
  // Run6
  {run:'Run6', caseId:'TC007', action:'DELETE /api/items/2', status:'failed', responseTime:350, contentType:'application/json', responseBody:{message:'not allowed'}},
  // Run7
  {run:'Run7', caseId:'TC008', action:'GET /api/masters/other', status:'passed', responseTime:180, contentType:'application/json', responseBody:{masters:123}}
];

const runs = ['Run1','Run2','Run3','Run4','Run5','Run6','Run7'];
const runSelector = document.getElementById('runSelector');
const statusFilter = document.getElementById('statusFilter');
const searchBox = document.getElementById('searchBox');
const resultTbody = document.querySelector('#resultTable tbody');
const metaInfo = document.getElementById('metaInfo');
const jsonModal = document.getElementById('jsonModal');
const jsonText = document.getElementById('jsonText');
const closeModal = document.getElementById('closeModal');
const downloadCsvBtn = document.getElementById('downloadCsv');
const toggleWatermarkBtn = document.getElementById('toggleWatermark');
const refreshBtn = document.getElementById('refresh');

function init() {
  runs.forEach(r => {
    const opt = document.createElement('option');
    opt.value = r; opt.textContent = r;
    runSelector.appendChild(opt);
  });
  runSelector.value = runs[0];

  renderAll();
  attachEvents();
}

function attachEvents(){
  runSelector.addEventListener('change', renderAll);
  statusFilter.addEventListener('change', renderAll);
  searchBox.addEventListener('input', renderAll);
  closeModal.addEventListener('click', ()=>jsonModal.style.display='none');
  jsonModal.addEventListener('click', (e)=>{ if(e.target===jsonModal) jsonModal.style.display='none';});
  downloadCsvBtn.addEventListener('click', downloadCsv);
  toggleWatermarkBtn.addEventListener('click', toggleWatermark);
  refreshBtn.addEventListener('click', ()=>{ renderAll(); flash('Refreshed'); });
}

function filteredData(){
  const run = runSelector.value;
  const status = statusFilter.value;
  const query = searchBox.value.trim().toLowerCase();

  return SAMPLE_DATA.filter(row=>{
    if(run && row.run !== run) return false;
    if(status !== 'all' && row.status !== status) return false;
    if(!query) return true;
    return (row.caseId && row.caseId.toLowerCase().includes(query)) ||
           (row.action && row.action.toLowerCase().includes(query));
  });
}

function renderAll(){
  const rows = filteredData();
  // summary
  const total = rows.length;
  const passed = rows.filter(r=>r.status==='passed').length;
  const failed = rows.filter(r=>r.status==='failed').length;
  const skipped = rows.filter(r=>r.status==='skipped').length;

  document.getElementById('totalTests').innerText = total;
  document.getElementById('totalPassed').innerText = passed;
  document.getElementById('totalFailed').innerText = failed;
  document.getElementById('totalSkipped').innerText = skipped;

  // table
  resultTbody.innerHTML = '';
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.run}</td>
      <td>${r.caseId}</td>
      <td>${escapeHtml(r.action)}</td>
      <td><span class="status-pill status-${r.status} ${r.status==='passed'?'status-passed':r.status==='failed'?'status-failed':'status-skipped'}">${capitalize(r.status)}</span></td>
      <td>${r.responseTime || 0}</td>
      <td>${r.contentType || '-'}</td>
      <td class="table-actions">
        <button class="small ghost" onclick='viewJson(${indexOfRow(r)})'>View JSON</button>
        <button class="small" onclick='copyResponse(${indexOfRow(r)})'>Copy</button>
      </td>
    `;
    resultTbody.appendChild(tr);
  });

  // charts
  updateTrendChart();
  updateDoughnutChart();
  updateTimes(rows);

  // meta info (example)
  metaInfo.innerText = `Environment: DEV | Mode: Suite | Executed: ${new Date().toLocaleString()} | Duration: ${calcDuration()} sec`;
}

function indexOfRow(row){
  // use index in SAMPLE_DATA to uniquely identify
  return SAMPLE_DATA.indexOf(row);
}

function viewJson(index){
  const row = SAMPLE_DATA[index];
  jsonText.textContent = JSON.stringify(row.responseBody, null, 2);
  jsonModal.style.display = 'flex';
}

function copyResponse(index){
  const row = SAMPLE_DATA[index];
  navigator.clipboard?.writeText(JSON.stringify(row.responseBody, null, 2))
    .then(()=> flash('Response copied to clipboard'))
    .catch(()=> flash('Copy not supported'));
}

function downloadCsv(){
  const rows = filteredData();
  if(rows.length===0){ flash('No rows to download'); return; }
  const csvRows = [];
  const headers = ['Run','CaseID','Action','Status','ResponseTime','ContentType'];
  csvRows.push(headers.join(','));
  rows.forEach(r=>{
    csvRows.push([r.run, r.caseId, `"${r.action.replace(/"/g,'""')}"`, r.status, r.responseTime, r.contentType].join(','));
  });
  const blob = new Blob([csvRows.join('\n')], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `api_results_${runSelector.value || 'run'}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

function toggleWatermark(){
  const wm = document.querySelector('.watermark');
  wm.style.display = (wm.style.display==='none') ? 'block' : 'none';
}

function calcDuration(){
  // example: sum of responseTimes divided by 1000 to simulate seconds - replace with your real duration
  const d = SAMPLE_DATA.reduce((s,r)=>s + (r.responseTime||0), 0);
  return Math.round(d/1000);
}

function updateTimes(rows){
  const times = rows.map(r=>r.responseTime||0).filter(t=>t>0);
  if(times.length===0){
    document.getElementById('avgTime').innerText='-- ms';
    document.getElementById('fastTime').innerText='-- ms';
    document.getElementById('slowTime').innerText='-- ms';
    return;
  }
  const avg = Math.round(times.reduce((a,b)=>a+b,0)/times.length);
  const fast = Math.min(...times);
  const slow = Math.max(...times);
  document.getElementById('avgTime').innerText = `${avg} ms`;
  document.getElementById('fastTime').innerText = `${fast} ms`;
  document.getElementById('slowTime').innerText = `${slow} ms`;
}

/* ------------- Charts ------------- */
let trendChart = null;
let doughnutChart = null;

function createCharts(){
  const ctxTrend = document.getElementById('trendChart').getContext('2d');
  trendChart = new Chart(ctxTrend, {
    type:'bar',
    data: {
      labels: runs,
      datasets: [
        {label:'Passed', data: runs.map(r=>countByRunStatus(r,'passed')), backgroundColor: '#28a745'},
        {label:'Failed', data: runs.map(r=>countByRunStatus(r,'failed')), backgroundColor: '#dc3545'},
        {label:'Skipped', data: runs.map(r=>countByRunStatus(r,'skipped')), backgroundColor: '#ffc107'}
      ]
    },
    options: {
      responsive:true,
      plugins:{legend:{position:'top'}},
      scales:{y:{beginAtZero:true,title:{display:true,text:'Test count'}}}
    }
  });

  const ctxD = document.getElementById('doughnutChart').getContext('2d');
  doughnutChart = new Chart(ctxD, {
    type:'doughnut',
    data: {
      labels:['Passed','Failed','Skipped'],
      datasets:[{data: [0,0,0], backgroundColor:['#28a745','#dc3545','#ffc107']}]
    },
    options:{cutout:'65%',plugins:{legend:{position:'bottom'}}}
  });
}

function updateTrendChart(){
  if(!trendChart) return;
  trendChart.data.datasets.forEach(ds=>{
    ds.data = runs.map(r=>countByRunStatus(r, ds.label.toLowerCase()));
  });
  trendChart.update();
}

function updateDoughnutChart(){
  if(!doughnutChart) return;
  const rows = filteredData();
  const passed = rows.filter(r=>r.status==='passed').length;
  const failed = rows.filter(r=>r.status==='failed').length;
  const skipped = rows.filter(r=>r.status==='skipped').length;
  doughnutChart.data.datasets[0].data = [passed, failed, skipped];
  doughnutChart.update();
}

function countByRunStatus(run, status){
  return SAMPLE_DATA.filter(r => r.run===run && r.status===status).length;
}

/* ---------- Helpers ---------- */
function capitalize(s){ return (s||'').toString().charAt(0).toUpperCase() + (s||'').toString().slice(1) }
function escapeHtml(s){ if(!s) return ''; return s.replace(/</g,'&lt;').replace(/>/g,'&gt;') }
function flash(msg){
  // small ephemeral toast
  const t = document.createElement('div');
  t.textContent = msg;
  t.style.position='fixed'; t.style.right='18px'; t.style.bottom='18px';
  t.style.background='#0d6efd'; t.style.color='#fff'; t.style.padding='10px 14px';
  t.style.borderRadius='8px'; t.style.boxShadow='0 6px 24px rgba(2,6,23,0.3)';
  document.body.appendChild(t);
  setTimeout(()=> t.style.opacity='0',1500);
  setTimeout(()=> t.remove(),2200);
}

/* ------------- wiring for sample ------------- */
createCharts();
init();

</script>
</body>
</html>
